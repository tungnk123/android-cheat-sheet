
---
**Full Context – Concise Knowledge Summary**

- **Weather API (OpenWeather)**
    

- **Forecast data is 3-hour slots, not real-time moments.**
    
- `**dt**` **= UTC seconds. Convert using** `**Instant + ZoneId**`**, never manual math.**
    

- **NOW logic (core bug + fix)**
    

- **❌ Do NOT compare hours (**`**hour == hour**`**).**
    
- **✅ NOW = current time is inside forecast slot range.**
    
- **Rule:** `**forecastTime ≤ now < forecastTime + interval**`**.**
    
- **Must also check same local day to avoid midnight bugs.**
    

- **Correct NOW implementation**
    

- **Use** `**Instant.ofEpochSecond(dt)**` **and** `**Instant.ofEpochMilli(now)**`**.**
    
- **Compare with** `**ZoneId.systemDefault()**` **or city timezone.**
    
- **If** `**forecastLocalDate != nowLocalDate**` **→ NOT NOW.**
    

- **RecyclerView NOW UI**
    

- **Adapter stores** `**currentTimeMillis**`**.**
    
- **Each item computes** `**isNowSlot**`**.**
    
- **Highlight via** `**isSelected**` **+ selector background.**
    
- **Update state only, do not reload list.**
    

- **Time formatting**
    

- **Use** `**Instant + ZoneId**` **for hour / AM-PM.**
    
- **Avoid** `**/3600**` **or offset math.**
    

- **Wind & unit handling**
    

- `**m/s → km/h = value * 3.6**`**.**
    
- **Unit conversion = domain logic.**
    
- **Text/unit formatting = UI layer.**
    
- **Support Metric / Imperial cleanly.**
    

- **Temperature & wind display**
    

- **Always go through extension helpers.**
    
- **No hard-coded units in UI.**
    

- **Weather description text**
    

- **Simple case fix:** `**"light snow" → "Light snow"**` **using** `**replaceFirstChar**`**.**
    
- **No deprecated** `**capitalize()**`**.**
    

- **Internationalization (i18n)**
    

- **Labels + units in** `**strings.xml**`**.**
    
- `**%**` **in strings =** `**%%**`**.**
    
- **UI text never hard-coded.**
    

- **Permissions (important bug)**
    

- **Location and Notification permissions must be requested sequentially.**
    
- **Do NOT set “requested” flags before system dialog shows.**
    
- **Notification permission must be requested after location flow completes.**
    

- **Location handling**
    

- **Use FusedLocationProvider.**
    
- **Fallback to last saved location if denied/fails.**
    
- **Realtime updates via** `**callbackFlow**`**.**
    

- **Architecture rules**
    

- **One observer per Flow.**
    
- **UI binding separated from Flow collection.**
    
- **Domain logic in extensions / helpers.**
    
- **Activities orchestrate, not compute.**
    

- **General best practices learned**
    

- **Avoid manual time math.**
    
- **Respect domain meaning of API data.**
    
- **State-driven UI > imperative UI updates.**
    
- **Flags should reflect real actions, not intentions.**